<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>ISS-Connectable Habitat Designer - NASA Space Apps 2025</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            overscroll-behavior: none; 
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }

        .header {
            background: linear-gradient(90deg, #1e3c72 0%, #2a5298 100%);
            padding: 0.8rem 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border-bottom: 2px solid #4a90e2;
            z-index: 10;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.2rem;
        }

        .header p {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .main-interface {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .sidebar {
            width: 320px;
            background: rgba(30, 30, 30, 0.95);
            border-right: 2px solid #4a90e2;
            padding: 1.5rem;
            overflow-y: auto;
            z-index: 5;
        }

        /* MOBILE & TABLET ADJUSTMENTS */
        @media (max-width: 768px) {
            .header { padding: 0.5rem 1rem; }
            .header h1 { font-size: 1.2rem; }
            .header p { display: none; } 

            .main-interface {
                flex-direction: column-reverse; 
            }

            .sidebar {
                width: 100%;
                height: 45%; 
                border-right: none;
                border-top: 2px solid #4a90e2;
                padding: 1rem;
            }

            .viewport {
                height: 55%; 
                width: 100%;
            }
            
            button, select, input { min-height: 44px; }
        }

        .sidebar-section {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-section h3 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: #4a90e2;
            font-weight: 600;
        }

        .mode-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .mode-btn {
            flex: 1;
            padding: 0.75rem;
            background: rgba(74, 144, 226, 0.2);
            border: 1px solid #4a90e2;
            border-radius: 6px;
            color: #ffffff;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: #4a90e2;
            font-weight: 600;
        }

        label {
            display: block;
            margin: 0.75rem 0 0.3rem 0;
            font-size: 0.9rem;
            color: #cccccc;
        }

        input[type='number'], select {
            width: 100%;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #ffffff;
            font-size: 0.9rem;
        }

        button {
            width: 100%;
            padding: 0.75rem;
            margin-top: 0.5rem;
            background: linear-gradient(135deg, #4a90e2, #357abd);
            border: none;
            border-radius: 6px;
            color: #ffffff;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        button.danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .component-list {
            max-height: 300px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; 
        }

        .component-item {
            padding: 0.75rem;
            margin: 0.5rem 0;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }

        .component-item:hover {
            background: rgba(74, 144, 226, 0.2);
            border-color: #4a90e2;
        }

        .component-item span {
            font-size: 1.2rem;
            margin-right: 0.8rem;
        }

        .viewport {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            position: relative;
        }

        .viewport-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background: rgba(0, 0, 0, 0.3);
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
        }

        .viewport-header h3 {
            font-size: 1rem;
            color: #4a90e2;
        }

        .view-controls button {
            width: auto;
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }

        #three-container {
            flex: 1;
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .status-bar {
            padding: 0.5rem 1rem;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: space-around;
            align-items: center;
            font-size: 0.8rem;
            flex-wrap: wrap;
        }

        .status-item {
            margin: 0 5px;
        }

        .status-value {
            color: #4a90e2;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <h1>ISS-Connectable Habitat Designer</h1>
            <p>Design modular habitats that connect to ISS or deploy on Moon/Mars</p>
        </header>

        <div class="main-interface">
            <aside class="sidebar">
                <div class="sidebar-section">
                    <h3>Deployment Mode</h3>
                    <div class="mode-selector">
                        <button class="mode-btn active" data-mode="space">Space (ISS)</button>
                        <button class="mode-btn" data-mode="surface">Surface (Moon/Mars)</button>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3>Your Habitat Module</h3>
                    <label>Module Shape:</label>
                    <select id="module-shape">
                        <option value="cylinder">Cylindrical Module</option>
                        <option value="sphere">Spherical Module</option>
                        <option value="rectangular">Rectangular Module</option>
                    </select>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <div style="flex:1">
                            <label>Diameter (m):</label>
                            <input type="number" id="module-diameter" value="4.5" min="2" max="15" step="0.5" />
                        </div>
                        <div style="flex:1">
                            <label>Length (m):</label>
                            <input type="number" id="module-length" value="8" min="3" max="20" step="0.5" />
                        </div>
                    </div>
                    <button id="update-module">Update Module</button>
                </div>

                <div class="sidebar-section" id="connection-section">
                    <h3>ISS Connection</h3>
                    <div style="display:flex; gap:10px;">
                         <div style="flex:1">
                            <label>Port:</label>
                            <select id="connection-port">
                                <option value="forward">Forward (+Z)</option>
                                <option value="aft">Aft (-Z)</option>
                                <option value="port">Port (-X)</option>
                                <option value="starboard">Starboard (+X)</option>
                                <option value="zenith">Zenith (+Y)</option>
                                <option value="nadir">Nadir (-Y)</option>
                            </select>
                        </div>
                        <div style="flex:1">
                            <label>Dist (m):</label>
                            <input type="number" id="connection-distance" value="5" min="0" max="20" step="0.5" />
                        </div>
                    </div>
                    <button id="attach-to-iss">Attach to ISS</button>
                    <button id="detach-from-iss" class="danger">Detach from ISS</button>
                </div>

                <div class="sidebar-section">
                    <h3>Internal Components</h3>
                    <div class="component-list">
                         <div class="component-item" data-type="crew-quarters"><span>üõèÔ∏è</span>Crew Quarters</div>
                        <div class="component-item" data-type="laboratory"><span>üî¨</span>Laboratory</div>
                        <div class="component-item" data-type="life-support"><span>üí®</span>Life Support System</div>
                        <div class="component-item" data-type="storage"><span>üì¶</span>Storage Bay</div>
                        <div class="component-item" data-type="airlock"><span>üö™</span>Airlock</div>
                        <div class="component-item" data-type="power"><span>‚ö°</span>Power System</div>
                    </div>
                </div>
                
                <div class="sidebar-section">
                     <button id="export-design">Export Design</button>
                     <button id="reset-design" class="danger">Reset Design</button>
                </div>
            </aside>

            <main class="viewport">
                <div class="viewport-header">
                    <h3 id="viewport-title">3D View</h3>
                    <div class="view-controls">
                        <button id="toggle-iss">Toggle ISS</button>
                        <button id="reset-view">Reset View</button>
                    </div>
                </div>
                <div id="three-container"></div>
                <div class="status-bar">
                    <div class="status-item">Mode: <span class="status-value" id="status-mode">Space</span></div>
                    <div class="status-item">Vol: <span class="status-value" id="status-volume">0</span>m¬≥</div>
                    <div class="status-item">Comps: <span class="status-value" id="status-components">0</span></div>
                    <div class="status-item">Connected: <span class="status-value" id="status-connected">No</span></div>
                </div>
            </main>
        </div>
    </div>

    <script>
        class HabitatDesigner {
            constructor() {
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.iss = null;
                this.userModule = null;
                this.internalComponents = [];
                this.mode = 'space';
                this.connected = false;
                this.issVisible = true;
                this.moduleConfig = { shape: 'cylinder', diameter: 4.5, length: 8 };
                
                this.raycaster = new THREE.Raycaster();
                this.mouse = new THREE.Vector2();
                this.draggedComponent = null;
                this.offset = new THREE.Vector3();
                this.dragPlane = new THREE.Plane();
                
                this.init();
            }

            init() {
                this.initThreeJS();
                this.createISS();
                this.createUserModule();
                this.setupEventListeners();
                this.setupDragDrop();
                this.animate();
                this.updateStatus();
            }

            initThreeJS() {
                const container = document.getElementById('three-container');
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x000000);

                this.camera = new THREE.PerspectiveCamera(60, container.clientWidth / container.clientHeight, 0.1, 1000);
                this.camera.position.set(30, 20, 30);
                this.camera.lookAt(0, 0, 0);

                this.renderer = new THREE.WebGLRenderer({ antialias: true });
                this.renderer.setSize(container.clientWidth, container.clientHeight);
                this.renderer.setPixelRatio(window.devicePixelRatio); 
                container.appendChild(this.renderer.domElement);

                this.scene.add(new THREE.AmbientLight(0xffffff, 0.5));
                const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
                dirLight.position.set(50, 50, 50);
                this.scene.add(dirLight);
                this.scene.add(new THREE.GridHelper(100, 50, 0x444444, 0x222222));
                
                this.setupControls(container);
            }

            // Touch & Mouse Controls
            setupControls(container) {
                let isDown = false;
                let startX, startY;
                let theta, phi, radius;

                const handleStart = (x, y) => {
                    if(this.draggedComponent) return;
                    isDown = true;
                    startX = x;
                    startY = y;
                    
                    const offset = new THREE.Vector3().copy(this.camera.position);
                    radius = offset.length();
                    theta = Math.atan2(offset.x, offset.z);
                    phi = Math.acos(Math.min(Math.max(offset.y / radius, -1), 1));
                };

                const handleMove = (x, y) => {
                    if (!isDown || this.draggedComponent) return;
                    
                    const deltaX = (x - startX) * 0.005;
                    const deltaY = (y - startY) * 0.005;

                    theta -= deltaX;
                    phi -= deltaY;
                    phi = Math.max(0.1, Math.min(Math.PI - 0.1, phi));

                    this.camera.position.x = radius * Math.sin(phi) * Math.sin(theta);
                    this.camera.position.y = radius * Math.cos(phi);
                    this.camera.position.z = radius * Math.sin(phi) * Math.cos(theta);
                    this.camera.lookAt(0, 0, 0);
                    
                    startX = x;
                    startY = y;
                };

                const handleEnd = () => { isDown = false; };

                // Mouse
                container.addEventListener('mousedown', e => handleStart(e.clientX, e.clientY));
                container.addEventListener('mousemove', e => handleMove(e.clientX, e.clientY));
                container.addEventListener('mouseup', handleEnd);
                container.addEventListener('mouseleave', handleEnd);
                container.addEventListener('wheel', e => {
                     if (this.draggedComponent) return;
                     const zoomSpeed = 0.1;
                     const direction = e.deltaY > 0 ? 1 : -1;
                     this.camera.position.multiplyScalar(1 + direction * zoomSpeed);
                });

                // Touch
                container.addEventListener('touchstart', e => {
                    if(e.touches.length === 1) handleStart(e.touches[0].clientX, e.touches[0].clientY);
                }, { passive: false });

                container.addEventListener('touchmove', e => {
                    if(e.touches.length === 1) {
                        e.preventDefault(); 
                        handleMove(e.touches[0].clientX, e.touches[0].clientY);
                    }
                }, { passive: false });

                container.addEventListener('touchend', handleEnd);
            }

            createISS() {
                this.iss = new THREE.Group();
                const core = new THREE.Mesh(new THREE.CylinderGeometry(2, 2, 15, 16), new THREE.MeshLambertMaterial({ color: 0xcccccc }));
                core.rotation.z = Math.PI / 2;
                this.iss.add(core);
                
                const panelMat = new THREE.MeshLambertMaterial({ color: 0x1a3d5c });
                const panel1 = new THREE.Mesh(new THREE.BoxGeometry(20, 0.2, 8), panelMat); panel1.position.y = 5;
                const panel2 = new THREE.Mesh(new THREE.BoxGeometry(20, 0.2, 8), panelMat); panel2.position.y = -5;
                this.iss.add(panel1, panel2);
                
                const portGeo = new THREE.CylinderGeometry(0.8, 0.8, 1, 16);
                const portMat = new THREE.MeshLambertMaterial({ color: 0xff6b6b });
                const ports = [
                    {pos: [8,0,0], rot:[0,0,Math.PI/2]}, {pos: [-8,0,0], rot:[0,0,Math.PI/2]},
                    {pos: [0,0,4], rot:[Math.PI/2,0,0]}, {pos: [0,0,-4], rot:[Math.PI/2,0,0]},
                    {pos: [0,3,0], rot:[0,0,0]}, {pos: [0,-3,0], rot:[0,0,0]}
                ];
                ports.forEach(p => {
                    const mesh = new THREE.Mesh(portGeo, portMat);
                    mesh.position.set(...p.pos);
                    mesh.rotation.set(...p.rot);
                    this.iss.add(mesh);
                });
                this.scene.add(this.iss);
            }

            createUserModule() {
                if (this.userModule) this.scene.remove(this.userModule);
                this.userModule = new THREE.Group();
                
                const { shape, diameter, length } = this.moduleConfig;
                const r = diameter / 2;
                let geo;
                
                if(shape === 'cylinder') geo = new THREE.CylinderGeometry(r, r, length, 32);
                else if(shape === 'sphere') geo = new THREE.SphereGeometry(r, 32, 16);
                else geo = new THREE.BoxGeometry(diameter, diameter, length);
                
                const mesh = new THREE.Mesh(geo, new THREE.MeshLambertMaterial({ color: 0x4a90e2, transparent: true, opacity: 0.8 }));
                if(shape === 'cylinder') mesh.rotation.z = Math.PI/2;
                
                this.userModule.add(mesh);
                
                // Connection port
                const port = new THREE.Mesh(new THREE.CylinderGeometry(0.6, 0.6, 0.8, 16), new THREE.MeshLambertMaterial({ color: 0x00ff00 }));
                port.position.x = -length / 2 - 0.4;
                port.rotation.z = Math.PI / 2;
                this.userModule.add(port);

                this.userModule.position.set(20, 0, 0);
                this.scene.add(this.userModule);
                
                // Re-add components
                this.internalComponents.forEach(c => this.userModule.add(c.mesh));
                this.updateStatus();
            }

            attachToISS() {
                const port = document.getElementById('connection-port').value;
                const distance = parseFloat(document.getElementById('connection-distance').value);
                const positions = {
                    forward: [8 + distance, 0, 0],
                    aft: [-8 - distance, 0, 0],
                    port: [0, 0, 4 + distance],
                    starboard: [0, 0, -4 - distance],
                    zenith: [0, 3 + distance, 0],
                    nadir: [0, -3 - distance, 0],
                };
                const targetPos = positions[port];
                this.userModule.position.set(...targetPos);
                 if (port === 'forward' || port === 'aft') {
                    this.userModule.rotation.y = port === 'forward' ? Math.PI : 0;
                } else if (port === 'port' || port === 'starboard') {
                    this.userModule.rotation.y = port === 'port' ? -Math.PI / 2 : Math.PI / 2;
                } else {
                    this.userModule.rotation.x = port === 'zenith' ? Math.PI / 2 : -Math.PI / 2;
                }
                this.connected = true;
                this.updateStatus();
            }
            
            detachFromISS() {
                this.userModule.position.set(20, 0, 0);
                this.userModule.rotation.set(0, 0, 0);
                this.connected = false;
                this.updateStatus();
            }

            addInternalComponent(type) {
                // Restored ORIGINAL DATA
                const componentData = {
                    'crew-quarters': { color: 0xff6b6b, size: 1.5, name: 'Crew Quarters' },
                    'laboratory': { color: 0x9c88ff, size: 1.8, name: 'Laboratory' },
                    'life-support': { color: 0x00ff00, size: 1.2, name: 'Life Support' },
                    'storage': { color: 0xffa500, size: 1.0, name: 'Storage Bay' },
                    'airlock': { color: 0x888888, size: 1.5, name: 'Airlock' },
                    'power': { color: 0xffff00, size: 1.3, name: 'Power System' },
                };
                
                const data = componentData[type];
                const mesh = new THREE.Mesh(new THREE.BoxGeometry(data.size, data.size, data.size), new THREE.MeshLambertMaterial({ color: data.color }));
                
                const range = this.moduleConfig.diameter / 2 - data.size;
                mesh.position.set(
                    (Math.random() - 0.5) * range,
                    (Math.random() - 0.5) * range,
                    (Math.random() - 0.5) * this.moduleConfig.length
                );
                mesh.userData.draggable = true;
                
                this.userModule.add(mesh);
                this.internalComponents.push({ mesh, type, name: data.name });
                this.updateStatus();
            }
            
            exportDesign() {
                const design = {
                    mode: this.mode,
                    module: this.moduleConfig,
                    connected: this.connected,
                    components: this.internalComponents.map((c) => ({
                        type: c.type,
                        name: c.name,
                        position: { x: c.mesh.position.x, y: c.mesh.position.y, z: c.mesh.position.z },
                    })),
                    volume: this.calculateVolume(),
                    timestamp: new Date().toISOString(),
                };
                const dataStr = JSON.stringify(design, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `habitat-design-${Date.now()}.json`;
                link.click();
                URL.revokeObjectURL(url);
            }

            resetDesign() {
                this.internalComponents.forEach((c) => this.userModule.remove(c.mesh));
                this.internalComponents = [];
                this.detachFromISS();
                this.updateStatus();
            }

            setupDragDrop() {
                const container = this.renderer.domElement;
                
                // Unified handler for Touch and Mouse
                const handleDragStart = (clientX, clientY) => {
                    const rect = container.getBoundingClientRect();
                    this.mouse.x = ((clientX - rect.left) / rect.width) * 2 - 1;
                    this.mouse.y = -((clientY - rect.top) / rect.height) * 2 + 1;
                    
                    this.raycaster.setFromCamera(this.mouse, this.camera);
                    const targets = this.internalComponents.map((c) => c.mesh);
                    const intersects = this.raycaster.intersectObjects(targets, false);
                    
                    if(intersects.length > 0) {
                        this.draggedComponent = intersects[0].object;
                        this.dragPlane.setFromNormalAndCoplanarPoint(this.camera.getWorldDirection(new THREE.Vector3()), intersects[0].point);
                        this.offset.copy(intersects[0].point).sub(this.draggedComponent.position);
                        container.style.cursor = 'grabbing';
                        return true; // Captured
                    }
                    return false;
                };

                const handleDragMove = (clientX, clientY) => {
                    if(!this.draggedComponent) return;
                    
                    const rect = container.getBoundingClientRect();
                    this.mouse.x = ((clientX - rect.left) / rect.width) * 2 - 1;
                    this.mouse.y = -((clientY - rect.top) / rect.height) * 2 + 1;
                    
                    this.raycaster.setFromCamera(this.mouse, this.camera);
                    const intersect = new THREE.Vector3();
                    this.raycaster.ray.intersectPlane(this.dragPlane, intersect);
                    
                    if(intersect) {
                        const newPos = intersect.sub(this.offset);
                        // Clamp
                        const d = this.moduleConfig.diameter;
                        const l = this.moduleConfig.length;
                        newPos.x = Math.max(-d, Math.min(d, newPos.x));
                        newPos.y = Math.max(-d, Math.min(d, newPos.y));
                        newPos.z = Math.max(-l / 2, Math.min(l / 2, newPos.z));
                        this.draggedComponent.position.copy(newPos);
                    }
                };

                const handleDragEnd = () => {
                    this.draggedComponent = null;
                    container.style.cursor = 'default';
                };

                // Mouse listeners
                container.addEventListener('mousedown', e => { if(e.button===0) handleDragStart(e.clientX, e.clientY); });
                container.addEventListener('mousemove', e => handleDragMove(e.clientX, e.clientY));
                container.addEventListener('mouseup', handleDragEnd);

                // Touch listeners
                container.addEventListener('touchstart', e => {
                    if(e.touches.length === 1) {
                       if(handleDragStart(e.touches[0].clientX, e.touches[0].clientY)) {
                           // e.preventDefault(); // Consumed by object drag
                       }
                    }
                }, {passive: false});
                
                container.addEventListener('touchmove', e => {
                    if(this.draggedComponent && e.touches.length === 1) {
                        e.preventDefault(); // Stop screen move while dragging object
                        handleDragMove(e.touches[0].clientX, e.touches[0].clientY);
                    }
                }, {passive: false});
                
                container.addEventListener('touchend', handleDragEnd);
            }

            setupEventListeners() {
                // Mode Switching
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.addEventListener('click', e => {
                        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.mode = e.target.dataset.mode;
                        if(this.mode === 'space') {
                            this.issVisible = true;
                            this.iss.visible = true;
                            document.getElementById('connection-section').style.display = 'block';
                             document.getElementById('viewport-title').textContent = '3D View: ISS + Your Module';
                             document.getElementById('mode-info').textContent = 'Space Mode: Design a module to attach to the ISS via docking ports';
                        } else {
                            this.issVisible = false;
                            this.iss.visible = false;
                            this.connected = false;
                            document.getElementById('connection-section').style.display = 'none';
                             document.getElementById('viewport-title').textContent = '3D View: Surface Habitat Module';
                             document.getElementById('mode-info').textContent = 'Surface Mode: Design a habitat for deployment on Moon or Mars surface';
                            this.userModule.position.set(0, this.moduleConfig.diameter/2, 0);
                            this.userModule.rotation.set(0,0,0);
                        }
                        this.updateStatus();
                    });
                });

                // Updates & Adds
                document.getElementById('update-module').addEventListener('click', () => {
                    this.moduleConfig.shape = document.getElementById('module-shape').value;
                    this.moduleConfig.diameter = parseFloat(document.getElementById('module-diameter').value);
                    this.moduleConfig.length = parseFloat(document.getElementById('module-length').value);
                    this.createUserModule();
                });

                document.getElementById('attach-to-iss').addEventListener('click', () => this.attachToISS());
                document.getElementById('detach-from-iss').addEventListener('click', () => this.detachFromISS());

                document.querySelectorAll('.component-item').forEach(item => {
                    item.addEventListener('click', () => this.addInternalComponent(item.dataset.type));
                    item.addEventListener('touchend', (e) => {
                        e.preventDefault(); 
                        this.addInternalComponent(item.dataset.type);
                    });
                });

                document.getElementById('toggle-iss').addEventListener('click', () => {
                    this.issVisible = !this.issVisible;
                    this.iss.visible = this.issVisible && this.mode === 'space';
                });

                document.getElementById('reset-view').addEventListener('click', () => {
                    this.camera.position.set(30,20,30);
                    this.camera.lookAt(0,0,0);
                });
                
                document.getElementById('export-design').addEventListener('click', () => this.exportDesign());
                document.getElementById('reset-design').addEventListener('click', () => this.resetDesign());

                // Handle Window Resize
                window.addEventListener('resize', () => {
                    const container = document.getElementById('three-container');
                    this.camera.aspect = container.clientWidth / container.clientHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(container.clientWidth, container.clientHeight);
                });
            }
            
            calculateVolume() {
                const { shape, diameter, length } = this.moduleConfig;
                const r = diameter / 2;
                if(shape === 'cylinder') return Math.PI * r * r * length;
                if(shape === 'sphere') return (4/3) * Math.PI * Math.pow(r, 3);
                return diameter * diameter * length;
            }

            updateStatus() {
                document.getElementById('status-mode').innerText = this.mode === 'space' ? 'Space (ISS)' : 'Surface';
                document.getElementById('status-volume').innerText = this.calculateVolume().toFixed(1);
                document.getElementById('status-components').innerText = this.internalComponents.length;
                document.getElementById('status-connected').innerText = this.connected ? 'Yes' : 'No';
            }

            animate() {
                requestAnimationFrame(() => this.animate());
                if(this.iss && this.mode === 'space') this.iss.rotation.y += 0.001;
                this.renderer.render(this.scene, this.camera);
            }
        }

        document.addEventListener('DOMContentLoaded', () => new HabitatDesigner());
    </script>
</body>
</html>
